# [geeguide](/README.md)
# 03. Cloud Masking TOA Product

## Objective
- Landsat TOA Cloud Mask
- Sentinel2 TOA Cloud Mask
## General Instruction
- Cloud contamination will lower NDVI values, measures like the timing of ‘green up’ or peak maturity would appear later than they actually occurred ([USGS, 2019](https://www.usgs.gov/land-resources/nli/landsat/landsat-collection-1-level-1-quality-assessment-band?qt-science_support_page_related_con=0#qt-science_support_page_related_con)). Therefore, cloud should be masked effectively and 'aggressively' when the images are used to analysis crop’s phenology.
- For Landsat TOA product, BQA band can be used to mask out cloud with decent performance. BQA band was generated using [CFMask Algorithm](https://www.usgs.gov/land-resources/nli/landsat/cfmask-algorithm).
Or ```ee.Algorithms.Landsat.simpleCloudScore()``` is a built-in GEE function can provide a shortcut to a rudimentary cloud scoring algorithm [GEE Documentation](https://developers.google.com/earth-engine/landsat). Behide the scene of the simpleCloudScore algorithm is described in this [gee script](https://code.earthengine.google.com/dc5611259d9ccab952526b3c2d05ce07).
- However, without a thermal band, current cloud detection methods for Sentinel 2 (eg.Fmask, Sen2Cor, MAJA, etc) could not provide satisfy results. Bright land surface such as white roof, sand beach, bare land, high turbidity surface water, etc. could be miss identified as cloud. Sentinel-2 optimal cloud mask is the main issue in [hls.gsfc.nasa.gov](https://hls.gsfc.nasa.gov/) initiative ([Claverie et.al,2018] (https://doi.org/10.1016/j.rse.2018.09.002))

## Core script
- Landsat8 cloud mask based on BQA
```
// Landsat 8 Cloud Masking Example
//https://gis.stackexchange.com/questions/292835/landsat-8-bqa-using-cloud-confidence-to-create-a-cloud-mask

var RADIX = 2;  // Radix for binary (base 2) data.

// Reference a sample Landsat 8 TOA image.
var image = ee.Image('LANDSAT/LC08/C01/T1_TOA/LC08_043034_20180202');
// Extract the QA band.
var image_qa = image.select('BQA');

var extractQABits = function (qaBand, bitStart, bitEnd) {
  var numBits = bitEnd - bitStart + 1;
  var qaBits = qaBand.rightShift(bitStart).mod(Math.pow(RADIX, numBits));
  //Map.addLayer(qaBits, {min:0, max:(Math.pow(RADIX, numBits)-1)}, 'qaBits');
  return qaBits;
};

// Create a mask for the dual QA bit "Cloud Confidence".
var bitStartCloudConfidence = 5;
var bitEndCloudConfidence = 6;
var qaBitsCloudConfidence = extractQABits(image_qa, bitStartCloudConfidence, bitEndCloudConfidence);
// Test for clouds, based on the Cloud Confidence value.
var testCloudConfidence = qaBitsCloudConfidence.gte(2);

// Create a mask for the dual QA bit "Cloud Shadow Confidence".
var bitStartShadowConfidence = 7;
var bitEndShadowConfidence = 8;
var qaBitsShadowConfidence = extractQABits(image_qa, bitStartShadowConfidence, bitEndShadowConfidence);
// Test for shadows, based on the Cloud Shadow Confidence value.
var testShadowConfidence = qaBitsShadowConfidence.gte(2);

// Calculate a composite mask and apply it to the image.   
var maskComposite = (testCloudConfidence.or(testShadowConfidence)).not();
var imageMasked = image.updateMask(maskComposite);

Map.addLayer(image, {bands:"B4,B3,B2", min:0, max:0.3}, 'original image', false);
Map.addLayer(image.select('BQA'), {min:0, max:10000}, 'BQA', false);
Map.addLayer(testCloudConfidence.mask(testCloudConfidence), {min:0, max:1, palette:'grey,white'}, 'testCloudConfidence');
Map.addLayer(testShadowConfidence.mask(testShadowConfidence), {min:0, max:1, palette:'grey,black'}, 'testShadowConfidence');
Map.addLayer(maskComposite.mask(maskComposite), {min:0, max:1, palette:'green'}, 'maskComposite', false);
Map.addLayer(imageMasked, {bands:"B4,B3,B2", min:0, max:0.3}, 'imageMasked');
```
- Landsat8 cloud mask based on ``` ee.Algorithms.Landsat.simpleCloudScore```
```
//apply these two functions to a Landsat image collection
function scoreL8_TOA (image) {
  var cloud = ee.Algorithms.Landsat.simpleCloudScore(image).select('cloud').rename('cloudScore');
  var cloudiness = cloud.reduceRegion({
    reducer: 'mean', 
    geometry: bekaa, 
    scale: 30,
  });
  return image.set(cloudiness).addBands(cloud);
}
function maskL8_TOA (img){
  var mask = img.select('cloudScore').lt(20);
  return img.updateMask(mask)
}
```

## Visualization and Checking

## References
1.
2. 
3. 

